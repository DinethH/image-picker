<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">


<dom-module id="image-picker">
  <template>
    <style>
      :host {
        display: block;
      }
      iron-selector {
        display: flex;
        flex-wrap: wrap;
      }
      .item {
        margin: 10px;
      }
      .iron-selected {
        opacity: 0.5;
      }
    </style>

    <!-- url$="get-categories.php" -->
    <iron-ajax
      auto
      url="/src/image-picker/get-categories.php"
      handle-as="json"
      last-response="{{categories}}"></iron-ajax>

    <h2>{{name}} ({{categoryid}})</h2>
    <h1>{{englishname}}</h1>

    <hr>

    <!-- url$="get-products.php?categoryid={{categoryid}}" -->
    <iron-ajax
      auto
      url="/src/image-picker/get-products.php?categoryid={{categoryid}}"
      handle-as="json"
      last-response="{{ajaxResponse}}"></iron-ajax>


    <iron-selector id="categories" multi selectedValues="{{selectedValues}}" attr-for-selected="name">

      <template is="dom-repeat" items="[[ajaxResponse]]">
        <div class="item" name="[[item.shopcategoryid]]">
          <img src="img.jpg">
          <div>[[item.title]]</div>
        </div>
      </template>


    </iron-selector>

    <paper-button id="continueButton" raised on-tap="continue">Continue</paper-button>


    <iron-ajax
      id="update"
      url="/src/image-picker/update-product.php?picks={{picksSerialized}}"
      handle-as="json"
      on-response="updateResponse"
      last-response="{{updateResponseJSON}}"></iron-ajax>

  </template>

  <script>
    Polymer({

      is: 'image-picker',

      properties: {
        "name": String,
        "categoryid": Number,
        "englishname": String,
        "picksSerialized": String,
        "categories": {
          observer: '_categoriesChanged'
        },
        "categoryCounter": {
          type: Number,
          value: 0
        },
        "ajaxResponse": {
          observer: '_ajaxResponseChanged'
        },
        "picks": {
          type: Array,
          value: []
        },
        "updateResponseJSON": {
          type: Object,
          observer: '_updateResponseJSONChanged'
        }
      },
      _updateResponseJSONChanged: function () {
        this.$.categories.selectedValues = null;
        
        this.picks = [];
        
        //console.log(this.updateResponseJSON);     
        
        

        if (this.categoryCounter < this.categories.length - 1){
          this.categoryCounter += 1
          let categoryCounter = this.categoryCounter;
          this.name = this.categories[categoryCounter].name;
          this.categoryid = this.categories[categoryCounter].categoryid;
          this.englishname = this.categories[categoryCounter].englishname;

          
        }
      },
      updateResponse: function () {
        //console.log(this.updateResponse);
      },
      _categoriesChanged: function () {
          if (this.categories != null) {
            this.name = this.categories[0].name;
            this.categoryid = this.categories[0].categoryid;
            this.englishname = this.categories[0].englishname;
          }
      },

      _ajaxResponseChanged: function () {
        
        /*
        for (let res in this.ajaxResponse) {
          let temp = new Object ();
          temp.shopcategoryid = this.ajaxResponse[res].shopcategoryid;
          temp.categoryid = this.ajaxResponse[res].categoryid;
          temp.correct = -1;
          this.picks.push(temp);
        }
        */
        
        //console.log(this.picks);
      },

      continue: function () {
        if (this.categoryCounter < this.categories.length) {
            
          for (let res in this.ajaxResponse) {
            let temp = new Object ();
            temp.shopcategoryid = this.ajaxResponse[res].shopcategoryid;
            temp.categoryid = this.ajaxResponse[res].categoryid;
            
            let selectedVals = this.$.categories.selectedValues;
            if (selectedVals.includes(temp.shopcategoryid)) {
              temp.correct = 1;
            } else {
              temp.correct = -1;
            }
            
            this.picks.push(temp);
          }
          
          this.picksSerialized = JSON.stringify(this.picks);
          
          if (this.categoryCounter == this.categories.length - 1) {
            this.$.continueButton.setAttribute('disabled', 'true');
          }
          
          

          this.$.update.generateRequest();
          
          

        }
      }
    });
  </script>
</dom-module>
